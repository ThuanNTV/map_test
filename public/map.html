<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bản Đồ Tương Tác - Bản Đồ Du Lịch Việt Nam</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
      }
      .header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .map-container {
        height: calc(100vh - 60px);
        position: relative;
      }
      #map {
        height: 100%;
        z-index: 1;
      }
      .location-info {
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 2;
        max-width: 300px;
      }
      .location-button {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 2;
        padding: 10px 20px;
        background: #2a5298;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .location-button:hover {
        background: #1e3c72;
      }
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
      }
      .location-marker {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2a5298;
        font-size: 24px;
      }
      .location-marker.capital {
        color: #e74c3c;
      }
      .location-marker.city {
        color: #2ecc71;
      }
      .location-marker.tourist {
        color: #f1c40f;
      }
      .user-location {
        color: #3498db;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1><i class="fas fa-map-marked-alt"></i> Bản Đồ Tương Tác</h1>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <div class="location-info">
        <h3><i class="fas fa-location-arrow"></i> Vị trí của bạn</h3>
        <p id="location-text">Đang tải vị trí...</p>
      </div>
      <button class="location-button" onclick="getLocation()">
        <i class="fas fa-crosshairs"></i> Lấy vị trí hiện tại
      </button>
    </div>

    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Khởi tạo bản đồ
      const map = L.map("map").setView([16.047079, 108.20623], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      // Danh sách các địa điểm du lịch
      const locations = [
        { name: "Hà Nội", lat: 21.0285, lng: 105.8542, type: "capital" },
        { name: "Hồ Chí Minh", lat: 10.7757, lng: 106.7004, type: "city" },
        { name: "Đà Nẵng", lat: 16.0544, lng: 108.2022, type: "city" },
        { name: "Hạ Long", lat: 20.9101, lng: 107.1839, type: "tourist" },
        { name: "Huế", lat: 16.4619, lng: 107.5909, type: "tourist" },
        { name: "Hội An", lat: 15.8801, lng: 108.338, type: "tourist" },
        { name: "Nha Trang", lat: 12.2388, lng: 109.1967, type: "tourist" },
        { name: "Phú Quốc", lat: 10.346, lng: 103.9874, type: "tourist" },
      ];

      // Thêm markers cho các địa điểm
      locations.forEach((location) => {
        const icon = L.divIcon({
          className: `location-marker ${location.type}`,
          html: `<i class="fas fa-map-marker-alt"></i>`,
          iconSize: [30, 30],
        });

        L.marker([location.lat, location.lng], { icon })
          .bindPopup(`<b>${location.name}</b>`)
          .addTo(map);
      });

      // Hàm hiển thị toast message
      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.style.display = "block";
        setTimeout(() => {
          toast.style.display = "none";
        }, duration);
      }

      // Hàm lấy vị trí người dùng
      function getLocation() {
        const loading = document.getElementById("loading");
        loading.style.display = "flex";

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              const locationText = document.getElementById("location-text");
              locationText.innerHTML = `
                            <strong>Vĩ độ:</strong> ${latitude.toFixed(6)}<br>
                            <strong>Kinh độ:</strong> ${longitude.toFixed(6)}
                        `;

              // Thêm marker cho vị trí người dùng
              L.marker([latitude, longitude], {
                icon: L.divIcon({
                  className: "user-location",
                  html: '<i class="fas fa-user-circle"></i>',
                  iconSize: [30, 30],
                }),
              })
                .bindPopup("Vị trí của bạn")
                .addTo(map);

              // Di chuyển bản đồ đến vị trí người dùng
              map.setView([latitude, longitude], 13);

              // Gửi vị trí đến server
              fetch(`/log?location=${latitude},${longitude}`)
                .then((response) => response.json())
                .then((data) => {
                  if (data.status === "ok") {
                    showToast("Đã cập nhật vị trí thành công!");
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  showToast("Có lỗi xảy ra khi cập nhật vị trí");
                });

              loading.style.display = "none";
            },
            (error) => {
              loading.style.display = "none";
              let message = "Không thể lấy vị trí của bạn. ";
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  message += "Bạn đã từ chối yêu cầu vị trí.";
                  break;
                case error.POSITION_UNAVAILABLE:
                  message += "Thông tin vị trí không khả dụng.";
                  break;
                case error.TIMEOUT:
                  message += "Yêu cầu vị trí đã hết thời gian chờ.";
                  break;
                default:
                  message += "Đã xảy ra lỗi không xác định.";
              }
              showToast(message);
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            }
          );
        } else {
          loading.style.display = "none";
          showToast("Trình duyệt của bạn không hỗ trợ Geolocation");
        }
      }

      // Tự động lấy vị trí khi trang được tải
      window.onload = getLocation;
    </script>
  </body>
</html>
